Plan operativo (6+2 semanas) ‚Äî Diamante primero, Coraz√≥n despu√©s

Actualizaci√≥n Semanas 3‚Äì6 (OOS rolling, guardrails y Decisi√≥n)

Objetivo (en cristiano)
	‚Ä¢	Diamante = ‚Äúfrancotirador‚Äù swing 4h con gesti√≥n por ATR y parcial. Lo que a√±adimos (loader de diamante_selected.yaml, gate de correlaci√≥n contra Perla) no cambia la l√≥gica ni tus resultados; son herramientas para automatizar selecci√≥n y evitar que la cartera quede ‚Äúpegada‚Äù a otra pata.
	‚Ä¢	Perla (V2) queda intocable por ahora; solo definimos c√≥mo leer sus series y, cuando toque, medir la correlaci√≥n para filtrar combinaciones demasiado similares. Eso es coherente con validaci√≥n temporal (walk-forward / forward-chaining) y con buenas pr√°cticas OOS.  Ôøº 
        Premisa: Perla no se toca (solo lectura de su CSV cuando exista). Diamante sigue siendo el ‚Äúfrancotirador‚Äù y mantiene independencia: el gate de correlaci√≥n sirve para evitar que se pegue a Perla durante la evaluaci√≥n.

Piezas nuevas y su prop√≥sito
	1.	Loader configs/diamante_selected.yaml
	‚Ä¢	Objetivo: que todas las corridas semanales usen la √∫ltima selecci√≥n (p. ej., H=90, TH=0.66) sin reescribir comandos.
	‚Ä¢	Efecto: estandariza y reduce errores. Los scripts cargan la selecci√≥n y la imprimen al inicio del run.
Ejemplo de YAML
yaml
# configs/diamante_selected.yaml
horizon: 90
threshold: 0.66
partial: "50_50"
fee_bps: 6
slip_bps: 6
rearm_min: 6
hysteresis_pp: 0.04

	2.	Gate de correlaci√≥n vs Perla: --perla_csv + --max_corr
	‚Ä¢	Objetivo: medir y limitar la correlaci√≥n efectiva entre la exposici√≥n/posiciones de Diamante y la serie binaria/posiciones de Perla en la ventana OOS.
	‚Ä¢	Efecto: si corr_perla > --max_corr, descarta esa config (evita ‚Äúduplicar‚Äù riesgo).
	‚Ä¢	Salida: los CSV (val_* o winners_*) incluyen una columna corr_perla.
Especificaci√≥n m√≠nima del CSV de Perla (--perla_csv)
	‚Ä¢	Debe cubrir la misma ventana temporal de validaci√≥n.
	‚Ä¢	Columnas aceptadas (al menos una):
	‚Ä¢	ts (ISO 8601 o epoch), m√°s una de:
	‚Ä¢	pos en {‚àí1, 0, +1} o {0, 1}
	‚Ä¢	signal en {0, 1}
	‚Ä¢	El script alinea por timestamp y calcula Pearson sobre las intersecciones v√°lidas.

‚∏ª

Semanas 3‚Äì4 ‚Äî OOS rolling & guardrails (con integraci√≥n de piezas)

Objetivo: validar out-of-sample encadenado, con guardrails de costes/r√©gimen y, si ya hay serie de Perla disponible, aplicar gate de correlaci√≥n para filtrar configs ‚Äúpegadas‚Äù.

Checklist semanal (Semanas 3‚Äì4)

A. Preparaci√≥n (cada lunes):
	‚Ä¢	Actualiza FREEZE/ventanas OOS (mes encadenado; forward-chaining).
	‚Ä¢	Verifica que existe configs/diamante_selected.yaml.
	‚Ä¢	(Opcional) Si ya tienes Perla semanal: confirma ruta --perla_csv.

B. Corridas base (con loader activo):
	‚Ä¢	Ejecuta validaci√≥n OOS con los costes acordados (slippage y fees de D√≠a 4).
	‚Ä¢	Sin cambiar flags manuales de H/TH: el loader inyecta tu elecci√≥n.
	‚Ä¢	Guarda KPIs y confirma impresi√≥n de selecci√≥n cargada en logs.

Ejemplo (placeholders de ventana OOS):
bash:
# Con YAML loader (no pasas H/TH a mano)
PYTHONPATH="$(pwd):$(pwd)/scripts" \
python backtest_grid.py \
  --windows "2025M01:2025-01-01:2025-01-31" \
  --signals_root reports/windows_fixed --ohlc_root data/ohlc/1m \
  --fee_bps 6 --slip_bps 6 --partial 50_50 --breakeven_after_tp1 \
  --risk_total_pct 0.75 --weights BTC-USD=1.0 \
  --gate_pf 1.6 --gate_wr 0.60 --gate_trades 30 \
  --out_csv reports/wf_2025M01.csv --out_top reports/wf_2025M01_top.csv

C. Gate de correlaci√≥n (activar s√≥lo si ya hay Perla):
	‚Ä¢	Ejecuta la misma validaci√≥n a√±adiendo --perla_csv ... --max_corr 0.35 (valor sugerido 0.30‚Äì0.40).
	‚Ä¢	Revisa que el CSV de salida tenga corr_perla y que respete el gate (descartes si > max_corr).

bash:
PYTHONPATH="$(pwd):$(pwd)/scripts" \
python backtest_grid.py \
  --windows "2025M01:2025-01-01:2025-01-31" \
  --signals_root reports/windows_fixed --ohlc_root data/ohlc/1m \
  --fee_bps 6 --slip_bps 6 --partial 50_50 --breakeven_after_tp1 \
  --risk_total_pct 0.75 --weights BTC-USD=1.0 \
  --gate_pf 1.6 --gate_wr 0.60 --gate_trades 30 \
  --perla_csv reports/perla_weekly_positions.csv \
  --max_corr 0.35 \
  --out_csv reports/wf_2025M01_corr.csv --out_top reports/wf_2025M01_corr_top.csv

D. Guardrails y stress:
	‚Ä¢	R√©gimen: mant√©n los filtros ya definidos (trend/ADX si aplica).
	‚Ä¢	Costes/latencia: repite con slip x2 y/o fee in/out mayores y confirma que PF OOS se mantiene aceptable (umbral interno ‚â•1.3 para stress).

E. Entregables Semanas 3‚Äì4:
	‚Ä¢	reports/wf_*.csv (con corr_perla si procede).
	‚Ä¢	reports/winners_wf.csv (finalistas tras gates + correlaci√≥n).
	‚Ä¢	Bit√°cora semanal de par√°metros cargados por loader (log).

‚∏ª

Semanas 4‚Äì6 ‚Äî Decisi√≥n (paper readiness)

Sem√°foro de decisi√≥n (con costes):
üü¢ PF ‚â• 1.15, Sortino ‚â• 0.50, MDD ‚â§ 1.1√ó baseline
(Se eval√∫a OOS acumulado de Semanas 3‚Äì6; la correlaci√≥n se usa como guardrail de independencia: preferir finalistas con corr_perla ‚â§ 0.35 si Perla est√° disponible).

Checklist semanal (Semanas 4‚Äì6)

A. Consolidaci√≥n OOS (rolling):
	‚Ä¢	Repite forward-chaining con loader activo (misma receta de arriba).
	‚Ä¢	Si Perla est√° disponible, mant√©n --perla_csv/--max_corr para todas las ventanas OOS.

B. Scorecard de decisi√≥n:
	‚Ä¢	Une los KPIs OOS (PF, WR, MDD, Sortino) de todas las semanas.
	‚Ä¢	Verifica que los finalistas tambi√©n cumplen corr_perla ‚â§ 0.35 (si aplica).
	‚Ä¢	Marca Sem√°foro (üü¢/üü°/üî¥).

C. Paper (si üü¢):
	‚Ä¢	Congela configs/diamante_selected.yaml y exporta perfil de riesgo.
	‚Ä¢	Genera ‚Äúplaybook‚Äù de ejecuci√≥n y alertas (bit√°cora, l√≠mites de MDD semanal, kill-switch).
	‚Ä¢	(Perla queda fuera; s√≥lo se usa su CSV como referencia de independencia).

Entregables Semanas 4‚Äì6:
	‚Ä¢	reports/wf_rollup.csv (todas las ventanas OOS concatenadas).
	‚Ä¢	reports/winners_final.csv (con corr_perla si procede).
	‚Ä¢	reports/decision_scorecard.md (sem√°foro + justificaci√≥n).
	‚Ä¢	configs/diamante_selected.yaml (congelado para paper).

‚∏ª
Qu√© hacen exactamente las piezas nuevas (para cuando toque)
	‚Ä¢	Loader diamante_selected.yaml: auto-inyecta tu √∫ltima selecci√≥n (p. ej. H=90, TH=0.66) sin tocar comandos.
	‚Ä¢	--perla_csv + --max_corr: (apagado por defecto) leen la serie de posici√≥n o se√±al binaria de Perla y calculan la correlaci√≥n efectiva con la exposici√≥n de Diamante en la ventana OOS; si supera --max_corr, se descarta esa config. Esto es una forma pr√°ctica de forzar diversificaci√≥n (evitar config ‚Äúpegadas‚Äù).  Ôøº

‚∏ª

Notas operativas r√°pidas
	‚Ä¢	Si no hay Perla a√∫n, deja fuera --perla_csv/--max_corr. El plan sigue igual; la correlaci√≥n se activa apenas est√© la serie disponible (misma ventana OOS).
	‚Ä¢	La correlaci√≥n efectiva se calcula sobre la exposici√≥n de Diamante (o se√±al binaria) y la pos/senal de Perla, alineadas por timestamp en la ventana. Se ignoran NaN tras alinear.
	‚Ä¢	corr_perla aparece en cada fila de los CSV de salida; si ejecutas rejillas, se aplica por cada combinaci√≥n candidata.

‚∏ª

Resumen de ‚Äúcu√°ndo usar qu√©‚Äù
	‚Ä¢	Loader diamante_selected.yaml:
‚ûú Desde Semana 3 en adelante en todas las corridas OOS.
Beneficio: consistencia y menos errores manuales.
	‚Ä¢	Gate --perla_csv / --max_corr:
‚ûú Semanas 3‚Äì6 solo si ya tienes la serie de Perla.
Beneficio: independencia de patas; evita configs demasiado correlacionadas (>0.35 sugerido).

Notas adicionales:
	‚Ä¢	El gate de correlaci√≥n es para filtrar configs excesivamente alineadas con Perla (para que Diamante conserve su rol de ‚Äúfrancotirador‚Äù independiente en la cartera). Esto est√° alineado con pr√°cticas de forward-chaining y diversificaci√≥n de cartera (minimizando covarianza entre legs).
	‚Ä¢	Si luego quieres hacer hard-gate (descartar filas con |corr|>max_corr) dentro del propio script, dilo y te dejo el filtro aplicado antes de guardar el CSV (ahora lo dejamos solo reportado en la columna corr_perla para inspecci√≥n).

¬øQuieres que tambi√©n te deje un helper zsh para correr con --use_selected + --perla_csv ya cableado y un agregador que ordene por bajo corr_perla manteniendo PF/WR gates?

Blindaje anti-regresiones (Diamante) ‚Äî Semanas 3‚Äì6

Objetivo: no degradar la versi√≥n actual de Diamante mientras buscamos mejores par√°metros.
Archivo can√≥nico: configs/diamante_selected.yaml (la √∫nica fuente de verdad).
D√≥nde guardamos: snapshots en reports/baseline/, experimentos en reports/experiments/.

Reglas:
	1.	Gate + No-regresi√≥n (obligatorio) antes de promover cualquier candidato:

	‚Ä¢	Gate por ventana OOS (walk-forward): PF ‚â• 1.15, Sortino ‚â• 0.50, MDD ‚â§ 1.1√ó baseline.
	‚Ä¢	Costes reales aplicados (slippage y comisi√≥n ida+vuelta).
	‚Ä¢	Igual lector/ENV y mismas ventanas que baseline.

	2.	Si falla gate: mantener familia de se√±ales y aplicar poda suave (subir threshold +0.01‚Äì0.02 o REARM_MIN +2) y revalidar en las mismas ventanas.
	3.	Promoci√≥n controlada: solo se copia sobre configs/diamante_selected.yaml cuando:

	‚Ä¢	pasa gate en todas las ventanas del per√≠odo, y
	‚Ä¢	pasa check de no-regresi√≥n contra el baseline congelado de la semana, y
	‚Ä¢	hay confirmaci√≥n manual.

	4.	Opcional (Semanas 3‚Äì4): filtro de independencia vs Perla:

	‚Ä¢	--perla_csv <ruta> + --max_corr <umbral> para descartar configs de Diamante demasiado pegadas a Perla (correlaci√≥n efectiva por exposici√≥n).
	‚Ä¢	Diamante se mantiene ‚Äúfrancotirador‚Äù; Perla sirve de referencia, no se toca (benchmarks).

Entregables de control (por semana):
	‚Ä¢	reports/baseline/diamante_week0.json (snap inicial de KPIs).
	‚Ä¢	reports/experiments/*.csv (candidatos).
	‚Ä¢	reports/check_noregr_last.txt + tabla de comparaci√≥n.
	‚Ä¢	Si se promueve: copia fechada configs/diamante_selected_YYYYMMDD_HHMM.yaml.

‚∏ª

Uso del gate de correlaci√≥n (Semanas 3‚Äì4, opcional)
	‚Ä¢	Banderas nuevas: --perla_csv, --max_corr
	‚Ä¢	Salida: a√±ade columna corr_perla al CSV de resultados; si corr_perla > max_corr, se descarta la config.
	‚Ä¢	Idea: mantener independencia de se√±ales; Perla como capturadora de ondas largas, Diamante como disparos selectivos.

‚∏ª

D√≠a 4 ‚Äî Costes realistas (hoy)
	1.	Repetir rejilla corta con 2√ó slippage (ej. --slip 0.0002) y fee ida+vuelta (ej. --cost 0.0004), mismas ventanas/--freeze_end.
	2.	Gate semanal: PF ‚â• 1.5 y WR ‚â• 60% con costes ‚Üí ‚úÖ Semana 1.
	3.	Si no pasa: poda suave (mismos lectores/ventanas) y revalidar.

Modelar costes evita sobreestimar; walk-forward evita mirar el futuro.

‚∏ª

Criterios de salida (Semanas 4‚Äì6)
	‚Ä¢	üü¢ Paper (riesgo reducido) si durante 4‚Äì6 semanas el candidato (o el baseline vigente) mantiene:
	‚Ä¢	PF ‚â• 1.15, Sortino ‚â• 0.50, MDD ‚â§ 1.1√ó baseline, y
	‚Ä¢	pasa no-regresi√≥n frente al baseline congelado, con costes.
	‚Ä¢	Si no: mantener baseline actual; registrar aprendizajes para fine-tuning posterior.
